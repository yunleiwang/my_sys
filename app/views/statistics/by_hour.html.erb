<% patient=Patient.find(params[:patient_id]) %>
<%= breadcrumbs("当前患者", patient.name, patient.id_number) %>
<!-- 为 ECharts 准备一个具备大小（宽高）的 DOM -->
<div style="width: 960px;height:100px; margin-top: 20px; margin-left: 80px">
  <div style="width:100%;text-align: center"><h1>当前日期：<%= params[:date].to_date.strftime("%Y-%m-%d") %></h1></div>
  <table id="monthtable" border="1px" style="width: 80%;height: 80px;text-align: center">
    <tr>
      <td>小时</td>
      <td>1时</td>
      <td>2时</td>
      <td>3时</td>
      <td>4时</td>
      <td>5时</td>
      <td>6时</td>
      <td>7时</td>
      <td>8时</td>
      <td>9时</td>
      <td>10时</td>
    </tr>
    <tr>
      <td>次数</td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td>小时</td>
      <td>11时</td>
      <td>12时</td>
      <td>13时</td>
      <td>14时</td>
      <td>15时</td>
      <td>16时</td>
      <td>17时</td>
      <td>18时</td>
      <td>19时</td>
      <td>20时</td>
    </tr>
    <tr>
      <td>次数</td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>

    </tr>
    <tr>
      <td>小时</td>
      <td>21时</td>
      <td>22时</td>
      <td>23时</td>
      <td>24时</td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td>次数</td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
    </tr>

  </table>
</div>
<div id="main" style="width: 960px;height:600px; margin-top: 100px"></div>

<script>
    $(document).ready(function(){
        var date = "<%= params[:date].to_date.strftime("%Y-%m-%d") %>";
        var patient_id = <%= params[:patient_id] %>;
        loadData(date,patient_id);
        function loadData(date, patient_id){
            $.ajax({
                url: '/statistics/by_hour_json',
                data: {date: date, patient_id:patient_id},
                type: 'get',
                dataType:'json',
                success:function(data){
                    drawTable('monthtable', data.series[0].data,data.eat_drug);
                    drawBar("main", data);
                },
                error:function(msg){
                    alert("系统发生错误")
                }
            })
        }



        function drawBar(divID,data) {
            var myChart = echarts.init(document.getElementById(divID));
            option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {type: 'cross'}
                },
//            toolbox: {
//                feature: {
//                    dataView: {show: true, readOnly: false},
//                    magicType: {show: true, type: [ 'line']},
//                    restore: {show: true},
//                    saveAsImage: {show: true}
//                }
//            },
                toolbox: {
                    show: true,
                    feature: {
                        saveAsImage: {
                            show:true,
                            excludeComponents :['toolbox'],
                            pixelRatio: 2
                        }
                    }
                },
                legend: {
                    data:["发病次数"]

                },
                xAxis: [
                    {
                        type: 'category',
                        data: data.item,
                        "axisLabel":{
                            rotate:45,//倾斜度 -90 至 90 默认为0
                            interval: 0
                        }
                    }
                ],
                yAxis: [
                    {
                        type: 'value',
                        name: '次数',

                        interval: 1,
                        axisLabel: {
                            formatter: '{value} '
                        }
                    },
                    {
                        type: 'value',
                        name: '次数',
                        interval: 1,
                        axisLabel: {
                            formatter: '{value}'
                        }
                    }
                ],

                series: data.series,
                //顶部数字展示pzr
                itemStyle: {
                    normal: {
                        label: {
                            show: true,//是否展示
                            textStyle: {
                                fontWeight:'bolder',
                                fontSize : '12',
                                fontFamily : '微软雅黑',
                            }
                        }
                    }
                },
            };
            // 使用刚指定的配置项和数据显示图表。
            myChart.setOption(option);

        }


        function drawTable(divId,data,eat_drug){
            var tds1 = $("#"+divId + " tr:nth-child(2) td")
            $.each(tds1, function(i, item){
                if(i==0){
                    item.innerHTML = '次数'
                }else{
                    console.log(data)
                    var str = null;
                    if(data[i-1]>0){
                        //str = "<i class='icon-check'></i>"+data[i-1]
                        str = data[i-1]
                    }

                    if(eat_drug[i-1]===true){
                        $("#"+divId + " tr:nth-child(1)").find("td").eq(i)[0].innerHTML =  $("#"+divId + " tr:nth-child(1)").find("td").eq(i)[0].innerHTML+'★'
                    }
                    item.innerHTML = str;
                }
            });

            var tds2 = $("#"+divId + " tr:nth-child(4) td")
            $.each(tds2, function(i, item){
                if(i==0){
                    item.innerHTML = '次数'
                }else{
                    var str = null;
                    if(data[10+i-1]>0){
                        //str = "<i class='icon-check'></i>"+data[10+i-1]
                        str = data[10+i-1]

                    }
                    if(eat_drug[10+i-1]===true){
                        $("#"+divId + " tr:nth-child(3)").find("td").eq(i)[0].innerHTML =  $("#"+divId + " tr:nth-child(3)").find("td").eq(i)[0].innerHTML+'★'
                    }
                    item.innerHTML = str;
                }
            });

            var tds3 = $("#"+divId + " tr:nth-child(6) td")
            $.each(tds3, function(i, item){
                if(i==0){
                    item.innerHTML = '次数'
                }else{
                    if(i>4){
                        return ;
                    }
                    console.log(data)
                    var str = null;
                    if(data[20+i-1]>0){
                        str = "<i class='icon-check'></i>"+data[20+i-1]
                    }
                    if(eat_drug[20+i-1]===true){
                        $("#"+divId + " tr:nth-child(5)").find("td").eq(i)[0].innerHTML =  $("#"+divId + " tr:nth-child(5)").find("td").eq(i)[0].innerHTML+'★'
                    }
                    item.innerHTML = str;
                }
            });
        }
    })
</script>